<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.ounwan.community">

	<!-- <select id="AetaList" resultType="aeta"> select * from CONCERN_BOARDS 
		order by BOARD_NUMBER DESC </select> -->
	<select id="AetaList" parameterType="map" resultType="aeta">
		select *
		from CONCERN_BOARDS
		order by BOARD_NUMBER DESC
		limit #{start},#{limit}
	</select>

	<select id="AetaSearchAll" parameterType="map" resultType="aeta">
		select * from CONCERN_BOARDS
		where
		title like
		CONCAT('%',#{inputValue},'%')
		or
		CLIENT_ID like
		CONCAT('%',#{inputValue},'%')
		order by BOARD_NUMBER DESC
		limit
		#{start},#{limit}
	</select>

	<select id="AetaSearchTitle" parameterType="map"
		resultType="aeta">
		select * from CONCERN_BOARDS
		where
		TITLE like CONCAT('%',#{inputValue},'%')
		order by BOARD_NUMBER DESC
		limit
		#{start},#{limit}
	</select>
	<select id="AetaSearchId" parameterType="map" resultType="aeta">
		select
		* from CONCERN_BOARDS
		where
		CLIENT_ID like CONCAT('%',#{inputValue},'%')
		order by BOARD_NUMBER DESC
		limit
		#{start},#{limit}
	</select>


	<select id="AetaCountAllPosts" resultType="int">
		select count(*) from
		CONCERN_BOARDS
	</select>

	<select id="AetaCountSearchAll" parameterType="String"
		resultType="int">
		select count(*) from
		CONCERN_BOARDS
		where
		title like
		CONCAT('%',#{inputValue},'%')
		or
		CLIENT_ID like
		CONCAT('%',#{inputValue},'%')
	</select>
	<select id="AetaCountSearchTitle" parameterType="String"
		resultType="int">
		select count(*) from
		CONCERN_BOARDS
		where
		title like
		CONCAT('%',#{inputValue},'%')
		or
		CLIENT_ID like
		CONCAT('%',#{inputValue},'%')
	</select>
	<select id="AetaCountSearchId" parameterType="String"
		resultType="int">
		select count(*) from
		CONCERN_BOARDS
		where
		title like
		CONCAT('%',#{inputValue},'%')
		or
		CLIENT_ID like
		CONCAT('%',#{inputValue},'%')
	</select>







	<insert id="AetaInsertPost" parameterType="aeta">
		INSERT INTO CONCERN_BOARDS (
		CLIENT_ID,TITLE,CONTENTS,CREATED_DATE)
		value(#{clientId},#{title},#{contents},now())
	</insert>
	
	<insert id="AetaInsertImageURL" parameterType="String">
		INSERT INTO CONCERN_BOARD_IMAGES 
		(BOARD_NUMBER,URL)
		values(
		(
			select MAX(BOARD_NUMBER) from CONCERN_BOARDS),
			#{imageUrl}
		);
	</insert>



	<select id="AetaPostToBeUpdated" parameterType="int"
		resultType="map">
		select cb.BOARD_NUMBER ,
		cb.TITLE ,
		cb.CONTENTS ,
		cbi.BOARD_IMAGE_NUMBER ,
		cbi.URL
		FROM CONCERN_BOARDS cb
		left outer join CONCERN_BOARD_IMAGES cbi
		on cb.BOARD_NUMBER =cbi.BOARD_NUMBER
		where cb.BOARD_NUMBER
		=#{boardNumber}
	</select>

	<update id="AetaUpdatePost" parameterType="aeta">
		UPDATE CONCERN_BOARDS
		SET
		TITLE= #{title},
		CONTENTS= #{contents},
		UPDATED_DATE=now()
		where
		BOARD_NUMBER =#{boardNumber};
	</update>
	
	<update id="AetaUpdatePostURL" parameterType="aetaImages">
		UPDATE CONCERN_BOARD_IMAGES 
		SET 
		URL= #{imageUrl}	
		where BOARD_NUMBER =#{boardNumber};

	</update>

	<delete id="AetaDeletePost" parameterType="int">
		DELETE FROM
		CONCERN_BOARDS
		WHERE BOARD_NUMBER =#{boardNumber};

	</delete>


	<select id="AetaReadPost" parameterType="int" resultType="map">

		SELECT
		cb.BOARD_NUMBER, cb.CLIENT_ID,
		cb.TITLE, cb.CONTENTS as AETA_CONTENTS,
		cb.CREATED_DATE as AETA_CREATED_DATE,
		cb.UPDATED_DATE as
		AETA_UPDATED_DATE,
		cb.VIEWS, cb.LIKES as AETA_LIKES,
		cbi.*,
		cmt.COMMENT_NUMBER,
		cmt.CLIENT_ID as COMMENTS_WRITER,
		cmt.BOARD_NUMBER,
		cmt.CREATED_DATE as COM_CREATED,
		cmt.CONTENTS as AETA_COMMENT,
		COUNT(cmt.CONTENTS) as COUNT_COMMENTS,
		SUM(COUNT(cmt.COMMENT_NUMBER))
		OVER (PARTITION BY cb.BOARD_NUMBER) AS AETA_TOTAL_COMMENTS,
		cmt.UPDATED_DATE as COM_UPDATED,
		cmt.LIKES as COM_LIKES,
		c_commenter.CLIENT_ID as COMMENTER_ID,
		c_writer.PROFILE_URL as
		WRITER_PHOTO,
		c_commenter.PROFILE_URL as COMMENTER_PHOTO
		from
		CONCERN_BOARDS cb
		LEFT join CONCERN_BOARD_IMAGES cbi
		on cb.BOARD_NUMBER
		=cbi.BOARD_NUMBER
		LEFT outer join COMMENTS cmt
		on
		cmt.BOARD_NUMBER
		=cb.BOARD_NUMBER
		LEFT OUTER JOIN CLIENTS c_writer
		on c_writer.CLIENT_ID
		=cb.CLIENT_ID
		Left OUTER JOIN CLIENTS c_commenter
		on
		c_commenter.CLIENT_ID = cmt.CLIENT_ID
		where cb.BOARD_NUMBER
		=#{boardNumber}
		GROUP BY cb.BOARD_NUMBER,
		cb.CLIENT_ID, cb.TITLE,
		cb.CONTENTS,
		cb.CREATED_DATE, cb.UPDATED_DATE, cb.VIEWS, cb.LIKES,
		cbi.BOARD_IMAGE_NUMBER,cbi.BOARD_NUMBER,cbi.URL,
		cmt.COMMENT_NUMBER,
		cmt.CLIENT_ID, cmt.BOARD_NUMBER,
		cmt.CREATED_DATE, cmt.CONTENTS,
		cmt.UPDATED_DATE, COM_LIKES
		ORDER BY cmt.COMMENT_NUMBER;
	</select>

	<select id="AetaCountLikes" parameterType="int" resultType="int">
		select count(BOARD_NUMBER) from AETA_LIKES
		where BOARD_NUMBER=
		#{boardNumber};
	</select>

	<select id="AetaLikesCheck" parameterType="aetaLikes"
		resultType="int">
		select count(BOARD_NUMBER) from AETA_LIKES
		where
		BOARD_NUMBER=#{boardNumber}
		and CLIENT_ID=#{clientId};
	</select>

	<insert id="AetaLike" parameterType="aetaLikes">
		INSERT INTO AETA_LIKES
		(BOARD_NUMBER,CLIENT_ID)
		values(#{boardNumber} ,#{clientId})
	</insert>

	<delete id="AetaDislike" parameterType="aetaLikes">
		DELETE from AETA_LIKES
		where BOARD_NUMBER=#{boardNumber}
		and CLIENT_ID=#{clientId}
	</delete>




	<insert id="AetaInsertComment" parameterType="aetaComments">
		INSERT INTO
		COMMENTS(CLIENT_ID, BOARD_NUMBER, CONTENTS, CREATED_DATE)
		values(#{clientId},#{boardNumber},#{contents},now())
	</insert>
	<delete id="AetaDeleteComment" parameterType="aetaComments">
		DELETE from
		COMMENTS
		where
		COMMENT_NUMBER =#{commentNumber}
	</delete>
	<update id="AetaUpdateView" parameterType="int">
		update CONCERN_BOARDS
		set
		views=views+1
		where BOARD_NUMBER=#{boardNumber}
	</update>


	<select id="FindClientId" parameterType="int">
		select CLIENT_ID
		from CONCERN_BOARDS
		where BOARD_NUMBER=#{boardNumber}
	</select>

</mapper>

