<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.ounwan.myPage">
	<!-- main -->


	<!-- refund -->
	<insert id="refundOrder" parameterType="refund">
		INSERT INTO REFUNDS
		(ORDER_NUMBER, REASON , REGISTERED_DATE)
		VALUES
		(#{orderNumber},
		#{reason} , now())
	</insert>

	<!-- change refund state -->
	<update id="changeRefundState" parameterType="String">
		UPDATE `ORDERS`
		SET `TRADE_HISTORY_NUMBER` = 5
		WHERE `ORDER_NUMBER` = #{orderNumber}
	</update>
	
	<!-- change purchase confirm state -->
	<update id="changeConfirmState" parameterType="String">
		UPDATE `ORDERS`
		SET `TRADE_HISTORY_NUMBER` = 4
		WHERE `ORDER_NUMBER` = #{orderNumber}
	</update>
	
	<!-- write Review -->
	<insert id="writeReview" parameterType="review">
		INSERT INTO REVIEWS
		(ORDER_DETAIL_NUMBER, CONTENTS, SCORE, CREATED_DATE, IMAGE_URL)
		VALUES
		(#{orderDetailNumber}, #{contents}, #{score}, now(), 
		<if test="imageUrl != null"> #{imageUrl} </if>
		<if test="imageUrl == null"> null </if>
		)
	</insert>
	
	<!-- 리뷰 작성하면 review 버튼 비활성화 -->
	<update id="disabledReviewButton">
		UPDATE `ORDER_DETAILS`
		SET `REVIEW_CHECK` = 1
		WHERE `ORDER_DETAIL_NUMBER` = #{orderDetailNumber}
	</update>

	<!-- wish list count -->
	<select id="wishListCount" parameterType="String"
		resultType="int">
		SELECT COUNT(*) FROM WISH_LISTS WHERE CLIENT_ID =
		#{clientId}
	</select>

	<!-- cart list count -->
	<select id="cartListCount" parameterType="String"
		resultType="int">
		SELECT COUNT(*) FROM CARTS WHERE CLIENT_ID = #{clientId}
	</select>

	<!-- orderListPreview -->
	<select id="orderPreviewList" parameterType="String"
		resultType="map">
		SELECT
		O.ORDER_NUMBER,
		O.ORDER_DATE,
		OD.PRICE,
		OD.QUANTITY,
		OD.ORDER_DETAIL_NUMBER,
		C.COUPUNG_NUMBER,
		C.NAME AS COUPUNG_NAME,
		PI.URL AS PRODUCT_IMAGE_URL
		FROM
		ORDERS O
		JOIN
		ORDER_DETAILS OD ON
		O.ORDER_NUMBER = OD.ORDER_NUMBER
		JOIN
		COUPUNG C ON OD.COUPUNG_NUMBER =
		C.COUPUNG_NUMBER
		LEFT JOIN
		PRODUCT_IMAGES PI ON C.COUPUNG_NUMBER =
		PI.COUPUNG_NUMBER
		WHERE
		O.CLIENT_ID = #{clientId}
		AND PI.TYPE = 0
		ORDER BY
		O.ORDER_DATE DESC
		LIMIT 3;
	</select>

	<!-- aetaListPreview -->
	<select id="aetaPreviewList" parameterType="String"
		resultType="aeta">
		SELECT *
		FROM AETA WHERE CLIENT_ID = #{clientId}
		ORDER
		BY
		AETA_NUMBER DESC LIMIT 3;
	</select>

	<!-- cartListPreview -->
	<select id="cartPreviewList" parameterType="String"
		resultType="map">
		SELECT
		C.NAME AS COUPUNG_NAME,
		C.AVAILABLE_STOCK,
		C.PRICE,
		C.COUPUNG_NUMBER,
		C.AVAILABLE_CHECK,
		CART.CART_NUMBER,
		CART.QUANTITY,
		PI.URL
		FROM
		COUPUNG C
		JOIN
		PRODUCT_IMAGES PI ON C.COUPUNG_NUMBER =
		PI.COUPUNG_NUMBER
		JOIN
		CARTS CART ON C.COUPUNG_NUMBER =
		CART.COUPUNG_NUMBER
		WHERE
		CART.CLIENT_ID = #{clientId}
		AND PI.TYPE = 0
		ORDER BY
		CART.CART_NUMBER DESC
		LIMIT 3;
	</select>

	<!-- coupung order list -->
	<select id="coupungOrderList" parameterType="String"
		resultType="map">
		SELECT
		O.ORDER_DATE,
		O.ORDER_NUMBER,
		O.TOTAL_PRICE,
		O.TOTAL_QUANTITY,
		C.COUPUNG_NUMBER,
		C.NAME AS COUPUNG_NAME,
		CO.NAME AS COUPUNG_OPTION_NAME,
		OD.ORDER_DETAIL_NUMBER,
		OD.PRICE,
		OD.QUANTITY,
		OD.REVIEW_CHECK,
		TH.TRADE_STEP,
		TH.TRADE_HISTORY_NUMBER,
		PI.URL
		FROM
		ORDERS O
		JOIN
		ORDER_DETAILS OD ON O.ORDER_NUMBER = OD.ORDER_NUMBER
		JOIN
		COUPUNG C
		ON OD.COUPUNG_NUMBER = C.COUPUNG_NUMBER
		JOIN
		COUPUNG_OPTIONS CO ON
		OD.COUPUNG_OPTION_NUMBER = CO.COUPUNG_OPTION_NUMBER
		JOIN
		TRADE_HISTORY
		TH ON O.TRADE_HISTORY_NUMBER = TH.TRADE_HISTORY_NUMBER
		JOIN
		PRODUCT_IMAGES PI ON C.COUPUNG_NUMBER = PI.COUPUNG_NUMBER
		WHERE
		O.CLIENT_ID = #{clientId}
		AND PI.TYPE = 0
		ORDER BY
		O.ORDER_DATE DESC;
	</select>

	<!-- danggun sale list -->
	<select id="danggunSaleList" parameterType="String"
		resultType="map">
		SELECT i.URL, d.PRODUCT_NAME, d.PRICE , d.UPLOAD_DATE ,
		d.TRADE_HISTORY_NUMBER, d.DANGGUN_NUMBER
		FROM DANGGUN d JOIN
		PRODUCT_IMAGES i ON
		d.DANGGUN_NUMBER =
		i.DANGGUN_NUMBER
		WHERE d.CLIENT_ID
		= #{clientId} AND
		i.TYPE = 0 ORDER BY i.DANGGUN_NUMBER
		DESC
	</select>

	<!-- danggun wish list -->
	<select id="danggunWishList" parameterType="String"
		resultType="map">
		SELECT
		w.WISH_LIST_NUMBER,
		i.URL,
		d.PRODUCT_NAME,
		d.PRICE,
		d.UPLOAD_DATE,
		d.TRADE_HISTORY_NUMBER,
		d.DANGGUN_NUMBER
		FROM WISH_LISTS w
		JOIN
		DANGGUN d
		ON
		w.DANGGUN_NUMBER = d.DANGGUN_NUMBER
		JOIN
		PRODUCT_IMAGES i
		ON
		d.DANGGUN_NUMBER = i.DANGGUN_NUMBER
		WHERE
		w.CLIENT_ID = #{clientId}
		AND
		i.TYPE = 0
		ORDER BY
		d.DANGGUN_NUMBER DESC
	</select>

	<!-- delete danaggun wish list -->
	<delete id="deleteWishList" parameterType="int">
		DELETE FROM WISH_LISTS
		WHERE WISH_LIST_NUMBER = #{wishListNumber}
	</delete>

	<!-- aeta list -->
	<select id="aetaList" parameterType="map" resultType="aeta">
		SELECT *
		FROM AETA 
		WHERE CLIENT_ID = #{clientId}
		AND VISIBILITY=1
		ORDER BY AETA_NUMBER DESC
		LIMIT #{start},#{limit}
	</select>
	<select id="countAetaList" parameterType ="String" resultType="int">
		SELECT count(*) 
		FROM AETA
		WHERE CLIENT_ID=#{clientId}
		AND VISIBILITY = 1
	</select>

	<!-- review list -->
	<select id="reviewList" parameterType="String" resultType="map">
		SELECT
		R.REVIEW_NUMBER,
		R.CONTENTS,
		R.SCORE,
		R.CREATED_DATE,
		R.IMAGE_URL,
		CO.NAME AS
		COUPUNG_NAME,
		CO.COUPUNG_NUMBER,
		COO.NAME AS
		COUPUNG_OPTION_NAME FROM
		REVIEWS R
		JOIN
		ORDER_DETAILS OD ON
		R.ORDER_DETAIL_NUMBER = OD.ORDER_DETAIL_NUMBER
		JOIN
		ORDERS O ON
		OD.ORDER_NUMBER = O.ORDER_NUMBER
		JOIN
		COUPUNG CO ON
		OD.COUPUNG_NUMBER =
		CO.COUPUNG_NUMBER
		JOIN
		COUPUNG_OPTIONS COO ON
		OD.COUPUNG_OPTION_NUMBER =
		COO.COUPUNG_OPTION_NUMBER
		WHERE
		O.CLIENT_ID =
		#{clientId}
		ORDER BY
		REVIEW_NUMBER DESC
	</select>

	<!-- delete review list -->
	<delete id="deleteReview" parameterType="int">
		DELETE FROM REVIEWS
		WHERE REVIEW_NUMBER = ${reviewNumber}
	</delete>

	<select id="getPwdById" parameterType="String"
		resultType="String">
		SELECT PASSWORD FROM CLIENTS WHERE CLIENT_ID=#{clientId}
	</select>

	<select id="getUserInfo" parameterType="String"
		resultType="clients">
		SELECT *
		FROM CLIENTS WHERE CLIENT_ID =
		#{clientId}
	</select>

	<update id="modifyPwd" parameterType="clients">
		UPDATE CLIENTS SET PASSWORD
		= #{password} WHERE CLIENT_ID = #{clientId}
	</update>

	<update id="modifyUserInfo" parameterType="String">
		UPDATE CLIENTS SET
		PHONE =
		#{phone}, ADDRESS = #{address}, ADDRESS_DETAIL =
		#{addressDetail},
		ZIP_CODE = #{zipCode} WHERE CLIENT_ID =
		#{clientId}
	</update>

	<update id="modifyProfileURL" parameterType="String">
		UPDATE CLIENTS SET
		PROFILE_URL = #{profileUrl} WHERE CLIENT_ID = #{clientId}
	</update>
	
	<update id="withdrawUserInfo" parameterType="clients">
		UPDATE CLIENTS SET ACTIVATION_CHECK = FALSE, PRIVACY_TERMS = #{privacyTerms} 
		WHERE CLIENT_ID = #{clientId}
	</update>
</mapper>